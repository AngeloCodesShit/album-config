
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuratore Album - Studio Andrea Materia</title>
    
    <!-- 1. Caricamento Librerie Esterne (React, Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "vite": "https://aistudiocdn.com/vite@^7.2.6",
    "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.1.1"
  }
}
</script>
</head>
<body class="bg-slate-50 text-slate-900">
    
    <div id="root"></div>

    <script type="text/babel">
        
        /********************************************************************************
         *  DATI E CONFIGURAZIONE
         ********************************************************************************/
        const PRICE_MULTIPLIER = 1.5;
        const COST_PER_ADDITIONAL_SPREAD = 7.92;
        const STANDARD_SPREADS = 30;
        const INCLUDED_MINIS = 2;
        const EXTRA_MINI_BASE_COST = 50.00; // Aggiornato a 50€

        // --- EXTRAS ---
        const EXTRAS = [
            { id: 'led', name: 'Supplemento LED', cost: 100.00, allowQuantity: false }, // Aggiornato a 100€
            { id: 'tamponatura', name: 'Supplemento Tamponatura', cost: 20.00, allowQuantity: false },
            { id: 'legno', name: 'Supplemento Legno (No Alpi)', cost: 40.00, allowQuantity: false },
            { id: 'cartoncino', name: 'Cartoncino Personalizzato', cost: 4.40, allowQuantity: true },
            { id: 'touch', name: 'Touch', cost: 2.24, allowQuantity: true },
            { id: 'velina', name: 'Velina HD', cost: 5.68, allowQuantity: true },
            { id: 'riporto', name: 'Riporto', cost: 12.00, allowQuantity: true },
        ];

        // --- MATERIALI COSTE & COPERTINE (Prezzi dal PDF) ---
        // Usiamo la stessa lista per Coste e Copertine Mini dove possibile, o definizioni specifiche
        const SPINE_OPTIONS = [
            { id: 'spine_coagulato', name: 'Coagulato / Woodplus (Base)', cost: 0, category: 'Base' },
            { id: 'spine_alcantara', name: 'Alcantara / Velur', cost: 15.00, category: 'Upgrade' }, // Prezzo stimato dai supplementi mini
            { id: 'spine_majolike', name: 'Majolike', cost: 70.00, category: 'Upgrade' },
            { id: 'spine_sense', name: 'Sense / Kamur', cost: 90.00, category: 'Upgrade' },
            { id: 'spine_groove', name: 'Groove', cost: 110.00, category: 'Upgrade' },
            { id: 'spine_stone', name: 'Woodplus Stone', cost: 120.00, category: 'Upgrade' },
            { id: 'spine_pelle', name: 'Pelle / Derma / Fragma', cost: 140.00, category: 'Upgrade' },
            { id: 'spine_triade', name: 'Triade', cost: 160.00, category: 'Upgrade' },
        ];

        // --- MINI COVERS ---
        const MINI_COVER_OPTIONS = [
            { id: 'mini_coagulato', name: 'Coagulato (Incluso)', cost: 0, category: 'Base' },
            { id: 'mini_alcantara', name: 'Alcantara / Velur', cost: 15.00, category: 'Upgrade' },
            { id: 'mini_kamur', name: 'Kamur', cost: 18.00, category: 'Upgrade' },
            { id: 'mini_derma', name: 'Derma / Pelle', cost: 20.00, category: 'Upgrade' },
            // Aggiungiamo opzioni più costose dal listino principale per completezza sui mini
            { id: 'mini_majolike', name: 'Majolike', cost: 65.00, category: 'Upgrade' },
            { id: 'mini_sense', name: 'Sense', cost: 80.00, category: 'Upgrade' },
        ];

        // --- COVERS PRINCIPALI ---
        const COVER_UPGRADES = [
            { id: 'std_woodplus', name: 'Woodplus (02-07-03-04-04 bicolor-08)', cost: 0, category: 'Base' },
            { id: 'std_vitro', name: 'Vitro', cost: 0, category: 'Base' },
            { id: 'std_lignum', name: 'Lignum', cost: 0, category: 'Base' },
            { id: 'std_opaque', name: 'Opaque (01-02-18)', cost: 0, category: 'Base' },
            { id: 'std_brandline', name: 'Brandline 24', cost: 0, category: 'Base' },
            { id: 'std_shabby', name: 'Shabby', cost: 0, category: 'Base' },

            { id: 'majolike', name: 'Majolike', cost: 70.00, category: 'Upgrade' }, 
            { id: 'majolike_sm', name: 'Majolike (Small)', cost: 65.00, category: 'Upgrade' }, 
            { id: 'majolike_lg', name: 'Majolike (Large)', cost: 80.00, category: 'Upgrade' }, 
            
            { id: 'sense', name: 'Sense (01-02)', cost: 90.00, category: 'Upgrade' }, 
            { id: 'sense_sm', name: 'Sense (Small)', cost: 80.00, category: 'Upgrade' }, 
            { id: 'sense_lg', name: 'Sense (Large)', cost: 100.00, category: 'Upgrade' }, 

            { id: 'groove', name: 'Groove', cost: 110.00, category: 'Upgrade' },
            { id: 'groove_sm', name: 'Groove (Small)', cost: 100.00, category: 'Upgrade' },
            { id: 'groove_lg', name: 'Groove (Large)', cost: 120.00, category: 'Upgrade' },

            { id: 'stone', name: 'Woodplus Stone', cost: 120.00, category: 'Upgrade' },
            { id: 'stone_sm', name: 'Woodplus Stone (Small)', cost: 110.00, category: 'Upgrade' },
            { id: 'stone_lg', name: 'Woodplus Stone (Large)', cost: 135.00, category: 'Upgrade' },

            { id: 'fragma', name: 'Fragma / Genesi / Loft / Pure', cost: 140.00, category: 'Upgrade' },
            { id: 'fragma_sm', name: 'Fragma / Genesi / Loft / Pure (Small)', cost: 125.00, category: 'Upgrade' },
            { id: 'fragma_lg', name: 'Fragma / Genesi / Loft / Pure (Large)', cost: 155.00, category: 'Upgrade' },
            
            { id: 'patch', name: 'Patch / Grance / Let Her', cost: 80.00, category: 'Upgrade' },
            { id: 'patch_sm', name: 'Patch / Grance / Let Her (Small)', cost: 70.00, category: 'Upgrade' },
            { id: 'patch_lg', name: 'Patch / Grance / Let Her (Large)', cost: 90.00, category: 'Upgrade' },

            { id: 'triade', name: 'Triade', cost: 160.00, category: 'Upgrade' },
            { id: 'triade_sm', name: 'Triade (Small)', cost: 145.00, category: 'Upgrade' },
            { id: 'triade_lg', name: 'Triade (Large)', cost: 175.00, category: 'Upgrade' },
        ];

        // --- BOX ---
        const BOX_OPTIONS = [
            { id: 'base_box', name: 'Recordia Box / Oyster / Girevole Semplice', cost: 0, includedWithBase: true },
            { id: 'mark_ii', name: 'Mark II, Vitro, Vitro Evo, True, Brooklyn', cost: 0.00 },
            { id: 'design_group', name: 'Mark II Lignum, Eclipse, Design', cost: 50.00 },
            { id: 'louvre', name: 'Louvre, Artika', cost: 100.00 },
            { id: 'lumiere', name: 'Lumiere', cost: 70.00 },
            { id: 'loft_group', name: 'Loft, Artika Plus, Monolite, Pure', cost: 130.00 },
            { id: 'hashtag', name: 'Hashtag', cost: 120.00 },
            { id: 'genesi_box', name: 'Genesi Box', cost: 180.00 },
            { id: 'triade_box', name: 'Triade Box', cost: 200.00 },
        ];

        // --- ALBUMS ---
        const ALBUMS = [
            {
                id: '40x30',
                name: 'Photoalbum 40x30',
                cost: 370.00,
                description: '30 Interni • 2 Mini Inclusi',
                compatibleBoxIds: ['base_box', 'mark_ii', 'design_group', 'louvre', 'lumiere', 'loft_group', 'hashtag', 'genesi_box', 'triade_box'],
                allowBasicOption: true // Abilita checkbox "Basic"
            },
            {
                id: '35x25',
                name: 'Photoalbum 35x25',
                cost: 340.00,
                description: '30 Interni • 2 Mini Inclusi',
                compatibleBoxIds: ['base_box', 'mark_ii', 'design_group', 'louvre', 'lumiere', 'loft_group', 'hashtag', 'genesi_box', 'triade_box']
            },
            {
                id: '45x35',
                name: 'Photoalbum 45x35',
                cost: 410.00,
                description: '30 Interni • 2 Mini Inclusi',
                compatibleBoxIds: ['base_box', 'mark_ii', 'design_group', 'louvre', 'lumiere', 'loft_group', 'hashtag', 'genesi_box', 'triade_box']
            },
            {
                id: 'battesimo',
                name: 'Battesimo 35x25',
                cost: 180.00,
                description: '12/13 Interni (25 Stampe) • Max 5 Lavorazioni',
                compatibleBoxIds: ['base_box'] 
            }
        ];

        // --- HELPER FUNCTIONS ---
        const getCompatibleCovers = (albumId) => {
            if (!albumId) return [];
            const baseCovers = COVER_UPGRADES.filter(c => c.category === 'Base');
            
            let suffix = '';
            if (albumId === '35x25' || albumId === 'battesimo') suffix = '_sm';
            else if (albumId === '45x35') suffix = '_lg';

            const upgradeCovers = COVER_UPGRADES.filter(c => {
                if (c.category === 'Base') return false;
                if (albumId === '40x30' && !c.id.includes('_sm') && !c.id.includes('_lg')) return true;
                if (c.id.endsWith(suffix)) return true;
                return false;
            });

            return [...baseCovers, ...upgradeCovers];
        };

        /********************************************************************************
         *  COMPONENTI UI
         ********************************************************************************/
        
        const { useState, useMemo } = React;

        // --- Selection Card ---
        const SelectionCard = ({ item, isSelected, onSelect, quantity = 0, onQuantityChange, extraContent }) => {
            const isQuantityEnabled = item.allowQuantity;

            const handleIncrement = (e) => {
                e.stopPropagation();
                if (onQuantityChange) onQuantityChange(quantity + 1);
            };

            const handleDecrement = (e) => {
                e.stopPropagation();
                if (onQuantityChange && quantity > 0) onQuantityChange(quantity - 1);
            };

            return (
                <div 
                    onClick={isQuantityEnabled ? undefined : onSelect}
                    className={`
                        relative rounded-xl border-2 p-4 transition-all duration-200 cursor-pointer
                        ${isSelected || (isQuantityEnabled && quantity > 0)
                        ? 'border-indigo-600 bg-indigo-50 shadow-md' 
                        : 'border-slate-200 bg-white hover:border-indigo-300 hover:shadow-sm'}
                    `}
                >
                    <div className="flex justify-between items-start">
                        <div className="flex-1 pr-4">
                            <h3 className={`font-semibold text-sm md:text-base ${isSelected || quantity > 0 ? 'text-indigo-900' : 'text-slate-800'}`}>
                                {item.name}
                            </h3>
                            {item.description && (
                                <p className="text-xs text-slate-500 mt-1">{item.description}</p>
                            )}
                            {extraContent}
                        </div>
                        
                        <div className="text-right">
                            <span className={`block font-bold text-sm ${isSelected || quantity > 0 ? 'text-indigo-700' : 'text-slate-700'}`}>
                                {item.cost === 0 ? 'Incl.' : `+€${item.cost.toFixed(2)}`}
                            </span>
                            
                            {!isQuantityEnabled && isSelected && (
                                <div className="mt-2 text-indigo-600">
                                    <div className="w-4 h-4 rounded-full bg-indigo-600 ml-auto" />
                                </div>
                            )}
                        </div>
                    </div>

                    {isQuantityEnabled && (
                        <div className="mt-4 flex items-center justify-end gap-3 border-t border-indigo-100 pt-3">
                            <button 
                                onClick={handleDecrement}
                                disabled={quantity === 0}
                                className={`w-8 h-8 rounded-full flex items-center justify-center text-lg font-bold transition-colors
                                ${quantity === 0 ? 'bg-slate-100 text-slate-300' : 'bg-white text-indigo-600 border border-indigo-200 hover:bg-indigo-50'}`}
                            >
                                -
                            </button>
                            <span className={`font-mono text-lg font-bold w-6 text-center ${quantity > 0 ? 'text-indigo-900' : 'text-slate-400'}`}>
                                {quantity}
                            </span>
                            <button 
                                onClick={handleIncrement}
                                className="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center text-lg font-bold hover:bg-indigo-700 transition-colors shadow-sm"
                            >
                                +
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // --- Summary Row Helper ---
        const SummaryRow = ({ label, sublabel, cost, isHeader = false, highlight = false, multiplier = PRICE_MULTIPLIER }) => {
            const clientPrice = cost * multiplier;
            return (
                <div className={`grid grid-cols-12 gap-2 text-sm py-2 ${isHeader ? 'font-bold text-slate-800 border-b border-slate-300 mb-2' : 'border-b border-slate-50 last:border-0'}`}>
                    <div className="col-span-6 flex flex-col justify-center">
                        <span className={`${highlight ? 'text-indigo-700 font-semibold' : 'text-slate-700'}`}>{label}</span>
                        {sublabel && <span className="text-xs text-slate-400">{sublabel}</span>}
                    </div>
                    <div className="col-span-3 text-right text-slate-500 font-mono flex items-center justify-end">
                        {isHeader ? 'Studio' : `€${cost.toFixed(2)}`}
                    </div>
                    <div className="col-span-3 text-right font-bold text-indigo-700 font-mono flex items-center justify-end bg-indigo-50/50 rounded px-1">
                        {isHeader ? 'Cliente' : `€${clientPrice.toFixed(2)}`}
                    </div>
                </div>
            );
        };

        // --- Summary (Sidebar) ---
        const Summary = ({ album, isBasicPackage, spreadCount, cover, spine, box, extras, miniCount, miniCover, miniSpine, onReset }) => {
            const [vatRate, setVatRate] = useState(22);

            // Calcoli
            const baseCost = album?.cost || 0;
            const spreadDiff = spreadCount - STANDARD_SPREADS;
            const spreadCostAdjustment = album ? spreadDiff * COST_PER_ADDITIONAL_SPREAD : 0;
            const coverCost = cover?.cost || 0;
            const spineCost = spine?.cost || 0;
            const boxCost = box?.cost || 0;

            // Mini Logic
            const extraMinis = Math.max(0, miniCount - INCLUDED_MINIS);
            // Ogni mini extra costa 50€ di base
            const miniBaseCostTotal = extraMinis * EXTRA_MINI_BASE_COST;
            // Le copertine e le coste si pagano per OGNI mini (anche quelli inclusi nel numero base, se sono upgrade)
            const miniCoverCostTotal = miniCover ? (miniCount * miniCover.cost) : 0;
            const miniSpineCostTotal = miniSpine ? (miniCount * miniSpine.cost) : 0;
            const totalMiniCost = miniBaseCostTotal + miniCoverCostTotal + miniSpineCostTotal;

            const extrasCost = extras.reduce((sum, { item, quantity }) => sum + (item.cost * quantity), 0);
            
            const totalCost = baseCost + spreadCostAdjustment + coverCost + spineCost + boxCost + totalMiniCost + extrasCost;
            
            // Basic Package Logic (Difference calculation)
            const diffFromBase = totalCost - (album ? album.cost : 0);

            const sellPrice = totalCost * PRICE_MULTIPLIER;
            const priceWithVat = sellPrice * (1 + vatRate / 100);

            return (
                <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden sticky top-6">
                    <div className="bg-slate-900 p-4 flex justify-between items-center">
                        <h2 className="text-white font-bold text-lg flex items-center gap-2">
                             <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                            Riepilogo
                        </h2>
                        <button onClick={onReset} className="text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded-md border border-slate-600">Reset</button>
                    </div>
                    
                    <div className="p-4">
                        {/* Table Header */}
                        <SummaryRow label="Voce" isHeader />

                        {/* Rows */}
                        <SummaryRow label="Album Base" sublabel={album?.name} cost={album ? album.cost : 0} />
                        
                        {spreadDiff !== 0 && (
                            <SummaryRow 
                                label={`${spreadDiff > 0 ? '+' : ''}${spreadDiff} Interni`} 
                                cost={spreadCostAdjustment} 
                            />
                        )}

                        {(coverCost > 0 || (cover && cover.name !== 'Woodplus')) && (
                             <SummaryRow label="Copertina" sublabel={cover?.name} cost={coverCost} />
                        )}

                        {(spineCost > 0) && (
                            <SummaryRow label="Costa (Dorso)" sublabel={spine?.name} cost={spineCost} />
                        )}

                        {(boxCost > 0) && (
                            <SummaryRow label="Box" sublabel={box?.name} cost={boxCost} />
                        )}

                        {/* Mini Section Summary */}
                        {miniCount > 0 && (
                            <>
                                <div className="border-t border-slate-100 my-1"></div>
                                <SummaryRow label={`Mini Album (${miniCount})`} sublabel={`${extraMinis} Extra a pagamento`} cost={miniBaseCostTotal} />
                                {miniCoverCostTotal > 0 && (
                                    <SummaryRow label="Cover Mini" sublabel={`${miniCover?.name} (x${miniCount})`} cost={miniCoverCostTotal} />
                                )}
                                {miniSpineCostTotal > 0 && (
                                    <SummaryRow label="Costa Mini" sublabel={`${miniSpine?.name} (x${miniCount})`} cost={miniSpineCostTotal} />
                                )}
                            </>
                        )}

                        {/* Extras */}
                        {extras.length > 0 && (
                            <>
                                <div className="border-t border-slate-100 my-1"></div>
                                {extras.map(({item, quantity}) => (
                                    <SummaryRow 
                                        key={item.id}
                                        label={item.name} 
                                        sublabel={quantity > 1 ? `Quantità: ${quantity}` : ''}
                                        cost={item.cost * quantity} 
                                    />
                                ))}
                            </>
                        )}

                        {/* Totals */}
                        <div className="border-t-2 border-slate-200 mt-4 pt-3">
                            
                            {/* Basic Package Highlight */}
                            {isBasicPackage && album && (
                                <div className="bg-orange-50 border border-orange-200 p-3 rounded-lg mb-4 text-center">
                                    <div className="text-xs text-orange-600 uppercase font-bold tracking-wider">Aggiunta al Base</div>
                                    <div className="text-2xl font-bold text-orange-700">€{(diffFromBase * PRICE_MULTIPLIER).toFixed(2)}</div>
                                    <div className="text-[10px] text-orange-400">Differenza Clienti (Totale - €{(album.cost * PRICE_MULTIPLIER).toFixed(2)})</div>
                                </div>
                            )}

                            <div className="flex justify-between items-end mb-1 px-1">
                                <div className="text-xs font-semibold uppercase tracking-wider text-slate-400">Totale Studio</div>
                                <div className="text-lg font-bold text-slate-600">€{totalCost.toFixed(2)}</div>
                            </div>
                            
                            <div className="bg-indigo-600 p-4 rounded-xl shadow-lg shadow-indigo-200 mt-2 text-white">
                                <div className="flex justify-between items-end">
                                    <div>
                                        <div className="text-xs text-indigo-200 font-medium uppercase tracking-wider mb-1">Totale Cliente</div>
                                        <div className="text-3xl font-bold leading-none">€{sellPrice.toFixed(2)}</div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-xs text-indigo-300">Moltiplicatore x{PRICE_MULTIPLIER}</div>
                                    </div>
                                </div>
                            </div>

                            <div className="flex items-center justify-between p-2 mt-4 bg-slate-100 rounded-lg">
                                <div className="flex items-center gap-2">
                                    <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider">IVA (%)</label>
                                    <input 
                                        type="number" min="0" max="100" value={vatRate}
                                        onChange={(e) => setVatRate(Number(e.target.value))}
                                        className="w-14 py-1 px-1 text-center bg-white border border-slate-300 rounded text-sm font-medium focus:ring-1 focus:ring-indigo-500 outline-none"
                                    />
                                </div>
                                <div className="text-right">
                                    <div className="text-[10px] text-slate-400 uppercase tracking-wide">Ivato Cliente</div>
                                    <div className="text-xl font-bold text-slate-800 leading-none">€{priceWithVat.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const INITIAL_STATE = {
                selectedAlbumId: null,
                isBasicPackage: false,
                spreadCount: STANDARD_SPREADS,
                selectedCoverId: null,
                selectedSpineId: SPINE_OPTIONS[0].id, // Default Spine Base
                selectedBoxId: null,
                miniCount: INCLUDED_MINIS,
                selectedMiniCoverId: MINI_COVER_OPTIONS[0].id,
                selectedMiniSpineId: SPINE_OPTIONS[0].id,
                extras: {}
            };

            const [state, setState] = useState(INITIAL_STATE);

            // Derived Data
            const selectedAlbum = useMemo(() => ALBUMS.find(a => a.id === state.selectedAlbumId) || null, [state.selectedAlbumId]);
            const compatibleCovers = useMemo(() => getCompatibleCovers(state.selectedAlbumId), [state.selectedAlbumId]);
            const selectedCover = useMemo(() => compatibleCovers.find(c => c.id === state.selectedCoverId) || null, [compatibleCovers, state.selectedCoverId]);
            const selectedSpine = useMemo(() => SPINE_OPTIONS.find(s => s.id === state.selectedSpineId) || null, [state.selectedSpineId]);
            
            const compatibleBoxes = useMemo(() => {
                if (!selectedAlbum) return [];
                return BOX_OPTIONS.filter(b => selectedAlbum.compatibleBoxIds.includes(b.id));
            }, [selectedAlbum]);
            const selectedBox = useMemo(() => compatibleBoxes.find(b => b.id === state.selectedBoxId) || null, [compatibleBoxes, state.selectedBoxId]);
            
            const selectedMiniCover = useMemo(() => MINI_COVER_OPTIONS.find(c => c.id === state.selectedMiniCoverId) || null, [state.selectedMiniCoverId]);
            const selectedMiniSpine = useMemo(() => SPINE_OPTIONS.find(s => s.id === state.selectedMiniSpineId) || null, [state.selectedMiniSpineId]);

            const selectedExtrasList = useMemo(() => {
                return Object.entries(state.extras)
                    .filter(([_, qty]) => qty > 0)
                    .map(([id, qty]) => {
                        const item = EXTRAS.find(e => e.id === id);
                        return item ? { item, quantity: qty } : null;
                    })
                    .filter(Boolean);
            }, [state.extras]);

            // Handlers
            const handleReset = () => {
                if (window.confirm("Sei sicuro di voler resettare tutta la configurazione?")) {
                    setState(INITIAL_STATE);
                }
            };

            const handleAlbumSelect = (id) => {
                setState(prev => ({
                    ...prev,
                    selectedAlbumId: id,
                    isBasicPackage: false, // Reset basic flag
                    spreadCount: STANDARD_SPREADS,
                    selectedCoverId: null,
                    selectedBoxId: null
                }));
            };

            return (
                <div className="min-h-screen flex flex-col">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="bg-indigo-600 text-white p-1.5 rounded-lg">
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                </div>
                                <h1 className="text-xl font-bold text-slate-900 tracking-tight">Configuratore Album</h1>
                            </div>
                            <div className="text-sm text-slate-500 hidden sm:block">Studio Fotografico Andrea Materia</div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow w-full">
                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            <div className="lg:col-span-8 space-y-10">
                                
                                {/* 1. Album */}
                                <section className="animate-fade-in">
                                    <div className="flex items-center gap-3 mb-4">
                                        <span className="flex items-center justify-center w-8 h-8 rounded-full bg-slate-900 text-white text-sm font-bold">1</span>
                                        <h2 className="text-xl font-bold text-slate-800">Formato e Interni</h2>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                                        {ALBUMS.map(album => (
                                            <SelectionCard
                                                key={album.id}
                                                item={album}
                                                isSelected={state.selectedAlbumId === album.id}
                                                onSelect={() => handleAlbumSelect(album.id)}
                                                extraContent={
                                                    album.allowBasicOption && state.selectedAlbumId === album.id && (
                                                        <div 
                                                            className="mt-3 bg-indigo-100 p-2 rounded-lg flex items-center gap-2"
                                                            onClick={(e) => e.stopPropagation()}
                                                        >
                                                            <input 
                                                                type="checkbox" 
                                                                id="basicPkg"
                                                                checked={state.isBasicPackage}
                                                                onChange={(e) => setState(p => ({...p, isBasicPackage: e.target.checked}))}
                                                                className="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500"
                                                            />
                                                            <label htmlFor="basicPkg" className="text-sm font-semibold text-indigo-900 cursor-pointer select-none">
                                                                Mostra solo aggiunte al Base
                                                            </label>
                                                        </div>
                                                    )
                                                }
                                            />
                                        ))}
                                    </div>
                                    {selectedAlbum && (
                                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                            <div className="flex justify-between items-center">
                                                <div>
                                                    <label className="font-semibold text-slate-700 block">Numero Interni</label>
                                                    <p className="text-xs text-slate-400 mt-1">Std: {STANDARD_SPREADS}. Extra: +/- €{COST_PER_ADDITIONAL_SPREAD}</p>
                                                </div>
                                                <div className="flex items-center gap-4 bg-slate-50 p-2 rounded-lg border border-slate-200">
                                                    <button onClick={() => setState(p => ({...p, spreadCount: Math.max(10, p.spreadCount - 1)}))} className="w-10 h-10 rounded-full bg-white border border-slate-300 font-bold hover:text-indigo-600">-</button>
                                                    <span className="text-xl font-bold text-indigo-900 w-12 text-center">{state.spreadCount}</span>
                                                    <button onClick={() => setState(p => ({...p, spreadCount: p.spreadCount + 1}))} className="w-10 h-10 rounded-full bg-indigo-600 text-white font-bold hover:bg-indigo-700">+</button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </section>

                                {/* 2. Cover & Spine */}
                                <section className={`transition-opacity duration-300 ${!selectedAlbum ? 'opacity-40 pointer-events-none' : 'opacity-100'}`}>
                                    <div className="flex items-center gap-3 mb-4">
                                        <span className="flex items-center justify-center w-8 h-8 rounded-full bg-slate-900 text-white text-sm font-bold">2</span>
                                        <h2 className="text-xl font-bold text-slate-800">Copertina e Costa</h2>
                                    </div>
                                    <div className="space-y-6">
                                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                            <h3 className="font-bold text-slate-700 mb-3">Materiale Costa (Dorso)</h3>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2">
                                                {SPINE_OPTIONS.map(spine => (
                                                    <SelectionCard key={spine.id} item={spine} isSelected={state.selectedSpineId === spine.id} onSelect={() => setState(p => ({...p, selectedSpineId: spine.id}))} />
                                                ))}
                                            </div>
                                        </div>

                                        <div>
                                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Copertine Base</h3>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                                {compatibleCovers.filter(c => c.category === 'Base').map(c => (
                                                    <SelectionCard key={c.id} item={c} isSelected={state.selectedCoverId === c.id} onSelect={() => setState(p => ({...p, selectedCoverId: c.id}))} />
                                                ))}
                                            </div>
                                        </div>
                                        <div>
                                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Copertine Premium</h3>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                                {compatibleCovers.filter(c => c.category === 'Upgrade').map(c => (
                                                    <SelectionCard key={c.id} item={c} isSelected={state.selectedCoverId === c.id} onSelect={() => setState(p => ({...p, selectedCoverId: c.id}))} />
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                {/* 3. Box */}
                                <section className={`transition-opacity duration-300 ${!selectedAlbum ? 'opacity-40 pointer-events-none' : 'opacity-100'}`}>
                                    <div className="flex items-center gap-3 mb-4">
                                        <span className="flex items-center justify-center w-8 h-8 rounded-full bg-slate-900 text-white text-sm font-bold">3</span>
                                        <h2 className="text-xl font-bold text-slate-800">Box</h2>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        {compatibleBoxes.map(b => (
                                            <SelectionCard key={b.id} item={b} isSelected={state.selectedBoxId === b.id} onSelect={() => setState(p => ({...p, selectedBoxId: b.id}))} />
                                        ))}
                                    </div>
                                </section>

                                {/* 4. Mini */}
                                <section className={`transition-opacity duration-300 ${!selectedAlbum ? 'opacity-40 pointer-events-none' : 'opacity-100'}`}>
                                    <div className="flex items-center gap-3 mb-4">
                                        <span className="flex items-center justify-center w-8 h-8 rounded-full bg-slate-900 text-white text-sm font-bold">4</span>
                                        <h2 className="text-xl font-bold text-slate-800">Mini Album</h2>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mb-6">
                                        <div className="flex justify-between items-center">
                                            <div>
                                                <label className="font-semibold text-slate-700 block">Quantità</label>
                                                <p className="text-xs text-slate-400 mt-1">{INCLUDED_MINIS} inclusi. Extra a €50.00 cad.</p>
                                            </div>
                                            <div className="flex items-center gap-4 bg-slate-50 p-2 rounded-lg border border-slate-200">
                                                <button onClick={() => setState(p => ({...p, miniCount: Math.max(0, p.miniCount - 1)}))} className="w-10 h-10 rounded-full bg-white border border-slate-300 font-bold hover:text-indigo-600">-</button>
                                                <span className="text-xl font-bold text-indigo-900 w-12 text-center">{state.miniCount}</span>
                                                <button onClick={() => setState(p => ({...p, miniCount: p.miniCount + 1}))} className="w-10 h-10 rounded-full bg-indigo-600 text-white font-bold hover:bg-indigo-700">+</button>
                                            </div>
                                        </div>
                                    </div>
                                    {state.miniCount > 0 && (
                                        <div className="space-y-6">
                                            <div>
                                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Costa Mini (Prezzo Cad.)</h3>
                                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                                                    {SPINE_OPTIONS.map(s => (
                                                        <SelectionCard key={s.id} item={s} isSelected={state.selectedMiniSpineId === s.id} onSelect={() => setState(p => ({...p, selectedMiniSpineId: s.id}))} />
                                                    ))}
                                                </div>
                                            </div>
                                            <div>
                                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Copertina Mini (Prezzo Cad.)</h3>
                                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                                                    {MINI_COVER_OPTIONS.map(o => (
                                                        <SelectionCard key={o.id} item={o} isSelected={state.selectedMiniCoverId === o.id} onSelect={() => setState(p => ({...p, selectedMiniCoverId: o.id}))} />
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </section>

                                {/* 5. Extras */}
                                <section className={`transition-opacity duration-300 ${!selectedAlbum ? 'opacity-40 pointer-events-none' : 'opacity-100'}`}>
                                    <div className="flex items-center gap-3 mb-4">
                                        <span className="flex items-center justify-center w-8 h-8 rounded-full bg-slate-900 text-white text-sm font-bold">5</span>
                                        <h2 className="text-xl font-bold text-slate-800">Extra</h2>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                        {EXTRAS.map(extra => (
                                            <SelectionCard 
                                                key={extra.id} item={extra} 
                                                isSelected={!!state.extras[extra.id]} 
                                                onSelect={() => !extra.allowQuantity && setState(p => ({...p, extras: {...p.extras, [extra.id]: p.extras[extra.id] ? 0 : 1}}))}
                                                quantity={extra.allowQuantity ? (state.extras[extra.id] || 0) : undefined}
                                                onQuantityChange={(q) => setState(p => ({...p, extras: {...p.extras, [extra.id]: q}}))}
                                            />
                                        ))}
                                    </div>
                                </section>
                            </div>

                            <div className="lg:col-span-4">
                                <Summary 
                                    album={selectedAlbum} isBasicPackage={state.isBasicPackage} spreadCount={state.spreadCount}
                                    cover={selectedCover} spine={selectedSpine} box={selectedBox}
                                    extras={selectedExtrasList} miniCount={state.miniCount}
                                    miniCover={selectedMiniCover} miniSpine={selectedMiniSpine} onReset={handleReset}
                                />
                            </div>
                        </div>
                    </main>
                    <footer className="bg-white border-t border-slate-200 mt-auto py-6 text-center">
                        <p className="text-slate-400 font-medium text-sm">Developed with ❤️ by Angelo</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
    

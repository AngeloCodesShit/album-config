<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuratore Album - Studio Andrea Materia</title>
    
    <!-- 1. External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Animation Utilities */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* Print Configuration */
        @media print {
            .no-print { display: none !important; }
            body { background: white; color: black; }
            #root { max-width: 100%; margin: 0; padding: 0; }
            .print-only { display: block !important; }
            
            /* Clean up UI for print */
            .shadow-xl, .shadow-md, .shadow-sm, .shadow-lg { box-shadow: none !important; }
            .border { border: 1px solid #e2e8f0 !important; }
            
            /* Ensure colors print correctly */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            
            /* Hide URL headers/footers in modern browsers if supported (optional) */
            @page { margin: 1cm; }
        }
        .print-only { display: none; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "vite": "https://esm.sh/vite@^7.2.7",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2"
  }
}
</script>
</head>
<body class="bg-slate-50 text-slate-900">
    
    <div id="root"></div>

    <script type="text/babel">
        
        /********************************************************************************
         *  1. DATA & CONFIGURATION
         ********************************************************************************/
        const PRICE_MULTIPLIER = 1.5;
        const COST_PER_ADDITIONAL_SPREAD = 7.92;
        const STANDARD_SPREADS = 30; 
        const INCLUDED_MINIS = 2;    
        const EXTRA_MINI_BASE_COST = 50.00; 

        // --- EXTRAS ---
        const EXTRAS = [
            { id: 'tascabile', name: 'Tascabile', cost: 25.00, allowQuantity: true },
            { id: 'led', name: 'Supplemento LED', cost: 100.00, allowQuantity: false },
            { id: 'tamponatura', name: 'Supplemento Tamponatura', cost: 20.00, allowQuantity: false },
            { id: 'legno', name: 'Supplemento Legno (No Alpi)', cost: 40.00, allowQuantity: false },
            { id: 'cartoncino', name: 'Cartoncino Personalizzato', cost: 4.40, allowQuantity: true },
            { id: 'touch', name: 'Touch', cost: 2.24, allowQuantity: true },
            { id: 'velina', name: 'Velina HD', cost: 5.68, allowQuantity: true },
            { id: 'riporto', name: 'Riporto', cost: 12.00, allowQuantity: true },
        ];

        // --- SPINES (MAIN ALBUM) ---
        const SPINE_OPTIONS = [
            { id: 'spine_coagulato', name: 'Coagulato / Woodplus (Base)', cost: 0, category: 'Base' },
            { id: 'spine_alcantara', name: 'Alcantara / Velur', cost: 15.00, category: 'Upgrade' }, 
            { id: 'spine_majolike', name: 'Majolike', cost: 70.00, category: 'Upgrade' },
            { id: 'spine_sense', name: 'Sense / Kamur', cost: 90.00, category: 'Upgrade' },
            { id: 'spine_groove', name: 'Groove', cost: 110.00, category: 'Upgrade' },
            { id: 'spine_stone', name: 'Woodplus Stone', cost: 120.00, category: 'Upgrade' },
            { id: 'spine_pelle', name: 'Pelle / Derma / Fragma', cost: 140.00, category: 'Upgrade' },
            { id: 'spine_triade', name: 'Triade', cost: 160.00, category: 'Upgrade' },
        ];

        // --- SPINES (MINI ALBUM) ---
        const MINI_SPINE_OPTIONS = [
            { id: 'mini_spine_coagulato', name: 'Coagulato (Incluso)', cost: 0 },
            { id: 'mini_spine_alcantara', name: 'Alcantara / Velur', cost: 15.00 },
            { id: 'mini_spine_kamur', name: 'Kamur', cost: 18.00 },
            { id: 'mini_spine_derma', name: 'Derma / Pelle', cost: 20.00 },
            { id: 'mini_spine_majolike', name: 'Majolike', cost: 65.00 },
            { id: 'mini_spine_sense', name: 'Sense', cost: 80.00 },
            { id: 'mini_spine_groove', name: 'Groove', cost: 90.00 },
            { id: 'mini_spine_stone', name: 'Woodplus Stone', cost: 100.00 },
            { id: 'mini_spine_fragma', name: 'Fragma / Genesi', cost: 120.00 },
            { id: 'mini_spine_triade', name: 'Triade', cost: 140.00 },
        ];

        // --- COVERS (MINI ALBUM) ---
        const MINI_COVER_OPTIONS = [
            { id: 'mini_coagulato', name: 'Coagulato (Incluso)', cost: 0, category: 'Base' },
            { id: 'mini_alcantara', name: 'Alcantara / Velur', cost: 15.00, category: 'Upgrade' },
            { id: 'mini_kamur', name: 'Kamur', cost: 18.00, category: 'Upgrade' },
            { id: 'mini_derma', name: 'Derma / Pelle', cost: 20.00, category: 'Upgrade' },
            { id: 'mini_majolike', name: 'Majolike', cost: 65.00, category: 'Upgrade' },
            { id: 'mini_sense', name: 'Sense', cost: 80.00, category: 'Upgrade' },
        ];

        // --- COVERS (MAIN ALBUM) ---
        const COVER_UPGRADES = [
            { id: 'std_woodplus', name: 'Woodplus (02-07-03-04-04 bicolor-08)', cost: 0, category: 'Base' },
            { id: 'std_vitro', name: 'Vitro', cost: 0, category: 'Base' },
            { id: 'std_lignum', name: 'Lignum', cost: 0, category: 'Base' },
            { id: 'std_opaque', name: 'Opaque (01-02-18)', cost: 0, category: 'Base' },
            { id: 'std_brandline', name: 'Brandline 24', cost: 0, category: 'Base' },
            { id: 'std_shabby', name: 'Shabby', cost: 0, category: 'Base' },

            { id: 'majolike', name: 'Majolike', cost: 70.00, category: 'Upgrade' }, 
            { id: 'majolike_sm', name: 'Majolike (Small)', cost: 65.00, category: 'Upgrade' }, 
            { id: 'majolike_lg', name: 'Majolike (Large)', cost: 80.00, category: 'Upgrade' }, 
            
            { id: 'sense', name: 'Sense (01-02)', cost: 90.00, category: 'Upgrade' }, 
            { id: 'sense_sm', name: 'Sense (Small)', cost: 80.00, category: 'Upgrade' }, 
            { id: 'sense_lg', name: 'Sense (Large)', cost: 100.00, category: 'Upgrade' }, 

            { id: 'groove', name: 'Groove', cost: 110.00, category: 'Upgrade' },
            { id: 'groove_sm', name: 'Groove (Small)', cost: 100.00, category: 'Upgrade' },
            { id: 'groove_lg', name: 'Groove (Large)', cost: 120.00, category: 'Upgrade' },

            { id: 'stone', name: 'Woodplus Stone', cost: 120.00, category: 'Upgrade' },
            { id: 'stone_sm', name: 'Woodplus Stone (Small)', cost: 110.00, category: 'Upgrade' },
            { id: 'stone_lg', name: 'Woodplus Stone (Large)', cost: 135.00, category: 'Upgrade' },

            { id: 'fragma', name: 'Fragma / Genesi / Loft / Pure', cost: 140.00, category: 'Upgrade' },
            { id: 'fragma_sm', name: 'Fragma / Genesi / Loft / Pure (Small)', cost: 125.00, category: 'Upgrade' },
            { id: 'fragma_lg', name: 'Fragma / Genesi / Loft / Pure (Large)', cost: 155.00, category: 'Upgrade' },
            
            { id: 'patch', name: 'Patch / Grance / Let Her', cost: 80.00, category: 'Upgrade' },
            { id: 'patch_sm', name: 'Patch / Grance / Let Her (Small)', cost: 70.00, category: 'Upgrade' },
            { id: 'patch_lg', name: 'Patch / Grance / Let Her (Large)', cost: 90.00, category: 'Upgrade' },

            { id: 'triade', name: 'Triade', cost: 160.00, category: 'Upgrade' },
            { id: 'triade_sm', name: 'Triade (Small)', cost: 145.00, category: 'Upgrade' },
            { id: 'triade_lg', name: 'Triade (Large)', cost: 175.00, category: 'Upgrade' },
        ];

        // --- BOX OPTIONS ---
        const BOX_OPTIONS = [
            { id: 'base_box', name: 'Recordia Box / Oyster / Girevole Semplice', cost: 0, includedWithBase: true },
            { id: 'mark_ii', name: 'Mark II, Vitro, Vitro Evo, True, Brooklyn', cost: 0.00 },
            { id: 'design_group', name: 'Mark II Lignum, Eclipse, Design', cost: 50.00 },
            { id: 'louvre', name: 'Louvre, Artika', cost: 100.00 },
            { id: 'lumiere', name: 'Lumiere', cost: 70.00 },
            { id: 'loft_group', name: 'Loft, Artika Plus, Monolite, Pure', cost: 130.00 },
            { id: 'hashtag', name: 'Hashtag', cost: 120.00 },
            { id: 'genesi_box', name: 'Genesi Box', cost: 180.00 },
            { id: 'triade_box', name: 'Triade Box', cost: 200.00 },
        ];

        // --- ALBUMS ---
        const ALBUMS = [
            {
                id: '40x30',
                name: 'Photoalbum 40x30',
                dimensions: '40x30',
                cost: 370.00,
                description: 'Standard',
                compatibleBoxIds: ['base_box', 'mark_ii', 'design_group', 'louvre', 'lumiere', 'loft_group', 'hashtag', 'genesi_box', 'triade_box'],
            },
            {
                id: '35x25',
                name: 'Photoalbum 35x25',
                dimensions: '35x25',
                cost: 370.00,
                description: 'Standard',
                compatibleBoxIds: ['base_box', 'mark_ii', 'design_group', 'louvre', 'lumiere', 'loft_group', 'hashtag', 'genesi_box', 'triade_box']
            },
            {
                id: '45x35',
                name: 'Photoalbum 45x35',
                dimensions: '45x35',
                cost: 370.00,
                description: 'Standard',
                compatibleBoxIds: ['base_box', 'mark_ii', 'design_group', 'louvre', 'lumiere', 'loft_group', 'hashtag', 'genesi_box', 'triade_box']
            },
            {
                id: 'battesimo',
                name: 'Battesimo 35x25',
                dimensions: '35x25',
                cost: 180.00,
                description: 'Standard',
                compatibleBoxIds: ['base_box'] 
            }
        ];

        // --- HELPER: Get Compatible Covers ---
        const getCompatibleCovers = (albumId) => {
            if (!albumId) return [];
            const baseCovers = COVER_UPGRADES.filter(c => c.category === 'Base');
            
            let suffix = '';
            if (albumId === '35x25' || albumId === 'battesimo') suffix = '_sm';
            else if (albumId === '45x35') suffix = '_lg';

            const upgradeCovers = COVER_UPGRADES.filter(c => {
                if (c.category === 'Base') return false;
                if (albumId === '40x30' && !c.id.includes('_sm') && !c.id.includes('_lg')) return true;
                if (c.id.endsWith(suffix)) return true;
                return false;
            });

            return [...baseCovers, ...upgradeCovers];
        };

        /********************************************************************************
         *  2. COMPONENTS
         ********************************************************************************/
        
        const { useState, useMemo, useEffect } = React;

        // --- Component: Selection Card ---
        const SelectionCard = ({ 
            item, 
            isSelected, 
            onSelect, 
            quantity = 0, 
            onQuantityChange, 
            extraContent,
            includedQuantity = 0,
            onIncludedQuantityChange
        }) => {
            const isQuantityEnabled = item.allowQuantity;

            const handleIncrement = (e) => {
                e.stopPropagation();
                if (onQuantityChange) onQuantityChange(quantity + 1);
            };

            const handleDecrement = (e) => {
                e.stopPropagation();
                if (onQuantityChange && quantity > 0) {
                    const newQty = quantity - 1;
                    onQuantityChange(newQty);
                    // Adjust included quantity if total drops below it
                    if (onIncludedQuantityChange && includedQuantity > newQty) {
                        onIncludedQuantityChange(newQty);
                    }
                }
            };

            // Toggle "Incluso": if unchecked -> 0. If checked -> max possible (quantity)
            const handleToggleIncluded = (e) => {
                e.stopPropagation();
                if (onIncludedQuantityChange) {
                    if (e.target.checked) {
                        // Default to ALL selected being included, user can adjust down
                        onIncludedQuantityChange(isQuantityEnabled ? quantity : 1); 
                    } else {
                        onIncludedQuantityChange(0);
                    }
                }
            }

            const handleIncludedIncrement = (e) => {
                e.stopPropagation();
                if (onIncludedQuantityChange && includedQuantity < quantity) {
                    onIncludedQuantityChange(includedQuantity + 1);
                }
            };

            const handleIncludedDecrement = (e) => {
                e.stopPropagation();
                if (onIncludedQuantityChange && includedQuantity > 0) {
                    onIncludedQuantityChange(includedQuantity - 1);
                }
            };

            // Calcolo Prezzo Cliente da mostrare
            const displayCost = item.cost * PRICE_MULTIPLIER;
            const isFullyIncluded = quantity > 0 && includedQuantity === quantity;

            return (
                <div 
                    onClick={isQuantityEnabled ? undefined : onSelect}
                    className={`
                        relative rounded-xl border-2 p-4 transition-all duration-200 cursor-pointer
                        ${isSelected || (isQuantityEnabled && quantity > 0)
                        ? 'border-indigo-600 bg-indigo-50 shadow-md' 
                        : 'border-slate-200 bg-white hover:border-indigo-300 hover:shadow-sm'}
                    `}
                >
                    <div className="flex justify-between items-start">
                        <div className="flex-1 pr-4">
                            <h3 className={`font-semibold text-sm md:text-base ${isSelected || quantity > 0 ? 'text-indigo-900' : 'text-slate-800'}`}>
                                {item.name}
                            </h3>
                            {item.description && (
                                <p className="text-xs text-slate-500 mt-1">{item.description}</p>
                            )}
                            {extraContent}
                        </div>
                        
                        <div className="text-right">
                            <span className={`block font-bold text-sm ${isSelected || quantity > 0 ? 'text-indigo-700' : 'text-slate-700'}`}>
                                {item.cost === 0 || isFullyIncluded ? 'Incl.' : `+€${displayCost.toFixed(2)}`}
                            </span>
                            
                            {!isQuantityEnabled && isSelected && (
                                <div className="mt-2 text-indigo-600">
                                    <div className="w-4 h-4 rounded-full bg-indigo-600 ml-auto" />
                                </div>
                            )}
                        </div>
                    </div>

                    {isQuantityEnabled && (
                        <div className="mt-4 flex items-center justify-end gap-3 border-t border-indigo-100 pt-3">
                            <button 
                                onClick={handleDecrement}
                                disabled={quantity === 0}
                                className={`w-8 h-8 rounded-full flex items-center justify-center text-lg font-bold transition-colors
                                ${quantity === 0 ? 'bg-slate-100 text-slate-300' : 'bg-white text-indigo-600 border border-indigo-200 hover:bg-indigo-50'}`}
                            >
                                -
                            </button>
                            <span className={`font-mono text-lg font-bold w-6 text-center ${quantity > 0 ? 'text-indigo-900' : 'text-slate-400'}`}>
                                {quantity}
                            </span>
                            <button 
                                onClick={handleIncrement}
                                className="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center text-lg font-bold hover:bg-indigo-700 transition-colors shadow-sm"
                            >
                                +
                            </button>
                        </div>
                    )}

                    {/* Checkbox "Incluso nel contratto" con gestione quantità */}
                    {(isSelected || quantity > 0) && onIncludedQuantityChange && (
                        <div 
                            className="mt-3 pt-2 border-t border-indigo-200"
                            onClick={(e) => e.stopPropagation()} 
                        >
                            <div className="flex items-center gap-2">
                                <input 
                                    type="checkbox" 
                                    id={`included-${item.id}`}
                                    checked={includedQuantity > 0} 
                                    onChange={handleToggleIncluded}
                                    className="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"
                                />
                                <label htmlFor={`included-${item.id}`} className="text-xs font-medium text-slate-700 cursor-pointer select-none">
                                    Incluso nel contratto
                                </label>
                            </div>
                            
                            {/* Controls for specific included quantity if checked and item allows quantity */}
                            {includedQuantity > 0 && isQuantityEnabled && (
                                <div className="flex items-center justify-between mt-2 pl-6">
                                    <span className="text-[10px] uppercase font-bold text-slate-500">Quantità inclusa:</span>
                                    <div className="flex items-center gap-2">
                                        <button 
                                            onClick={handleIncludedDecrement}
                                            className="w-5 h-5 rounded flex items-center justify-center bg-slate-200 text-slate-600 text-xs font-bold hover:bg-slate-300"
                                        >
                                            -
                                        </button>
                                        <span className="text-xs font-bold w-4 text-center text-indigo-700">{includedQuantity}</span>
                                        <button 
                                            onClick={handleIncludedIncrement}
                                            className={`w-5 h-5 rounded flex items-center justify-center text-xs font-bold
                                            ${includedQuantity < quantity ? 'bg-slate-200 text-slate-600 hover:bg-slate-300' : 'bg-slate-100 text-slate-300 cursor-not-allowed'}`}
                                            disabled={includedQuantity >= quantity}
                                        >
                                            +
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // --- Component: Summary Sidebar ---
        const Summary = ({ contract, album, spreadCount, cover, spine, box, extras, includedExtraCounts, miniCount, miniCover, miniSpine, onReset }) => {
            const [vatRate, setVatRate] = useState(22);

            // 1. Spreads Adjustment
            const spreadDiff = spreadCount - contract.includedSpreads;
            const spreadCostAdjustment = spreadDiff * COST_PER_ADDITIONAL_SPREAD;

            // 2. Supplementi Standard
            const coverCost = cover?.cost || 0;
            const spineCost = spine?.cost || 0;
            const boxCost = box?.cost || 0;

            // 3. Mini Albums
            const extraMinis = Math.max(0, miniCount - contract.includedMinis);
            const miniBaseCostTotal = extraMinis * EXTRA_MINI_BASE_COST;
            const miniCoverCostTotal = miniCover ? (miniCount * miniCover.cost) : 0;
            const miniSpineCostTotal = miniSpine ? (miniCount * miniSpine.cost) : 0;
            const totalMiniVariations = miniBaseCostTotal + miniCoverCostTotal + miniSpineCostTotal;

            // 4. Extras (Separazione tra pagati e inclusi con quantità)
            const processedExtras = extras.map(({ item, quantity }) => {
                const includedQty = includedExtraCounts[item.id] || 0;
                // Ensure we don't count more included than selected (safety check)
                const validIncludedQty = Math.min(quantity, includedQty);
                const paidQty = Math.max(0, quantity - validIncludedQty);
                return { item, totalQty: quantity, includedQty: validIncludedQty, paidQty };
            });

            const paidExtras = processedExtras.filter(e => e.paidQty > 0);
            const includedExtrasList = processedExtras.filter(e => e.includedQty > 0);
            
            const extrasCost = paidExtras.reduce((sum, { item, paidQty }) => sum + (item.cost * paidQty), 0);
            
            // TOTALI
            const totalVariationsCostStudio = spreadCostAdjustment + coverCost + spineCost + boxCost + totalMiniVariations + extrasCost;
            const totalVariationsPriceClient = totalVariationsCostStudio * PRICE_MULTIPLIER;

            const finalPriceClient = contract.agreedPrice + totalVariationsPriceClient;
            const priceWithVat = finalPriceClient * (1 + vatRate / 100);

            // CALCOLO DATI STUDIO
            // Assumiamo che album.cost sia il costo base dello studio per l'album standard
            const baseStudioCost = album ? album.cost : 0;
            const totalStudioCost = baseStudioCost + totalVariationsCostStudio;
            const studioMargin = finalPriceClient - totalStudioCost;

            const handlePrint = () => {
                window.print();
            };

            return (
                <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden sticky top-6">
                    <div className="bg-slate-900 p-4 flex justify-between items-center no-print">
                        <div className="flex items-center gap-3">
                            <h2 className="text-white font-bold text-lg flex items-center gap-2">
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                                Riepilogo
                            </h2>
                        </div>
                        <div className="flex gap-2">
                             <button onClick={handlePrint} className="text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded-md border border-indigo-500 flex items-center gap-1">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                                Stampa
                            </button>
                            <button onClick={onReset} className="text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded-md border border-slate-600">Reset</button>
                        </div>
                    </div>
                    
                    {/* Header Contratto */}
                    <div className="bg-slate-50 p-4 border-b border-slate-200">
                        <div className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-2">Base Contratto</div>
                        <div className="flex justify-between items-center mb-1">
                            <span className="font-semibold text-slate-700">{contract.clientName || 'Cliente'}</span>
                            <span className="font-bold text-slate-900">€{contract.agreedPrice.toFixed(2)}</span>
                        </div>
                        <div className="text-xs text-slate-500 flex flex-wrap gap-x-3 gap-y-1">
                            <span>• {album?.name}</span>
                            <span>• Formato {album?.dimensions}</span>
                            <span>• {contract.includedSpreads} Interni</span>
                            <span>• {contract.includedMinis} Mini</span>
                        </div>
                        
                        {/* Lista Extra Inclusi */}
                        {includedExtrasList.length > 0 && (
                            <div className="mt-3 pt-2 border-t border-slate-200">
                                <span className="text-[10px] uppercase font-bold text-slate-400 block mb-1">Extra Inclusi (Gratuiti):</span>
                                <div className="text-xs text-slate-600 flex flex-wrap gap-2">
                                    {includedExtrasList.map(e => (
                                        <span key={e.item.id} className="bg-white border border-slate-200 px-1.5 py-0.5 rounded">
                                            {e.item.name} {e.includedQty > 1 ? `(x${e.includedQty})` : ''}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <div className="p-4">
                        <div className="pb-2 border-b border-slate-100 flex justify-between items-end mb-2">
                            <h3 className="text-sm font-bold text-indigo-900 uppercase tracking-wide">Aggiunte / Variazioni</h3>
                        </div>

                        {/* List Items (Solo Variazioni Pagate) */}
                        <div className="space-y-2">
                            {spreadDiff !== 0 && (
                                <div className="flex justify-between text-sm text-slate-600">
                                    <span>{spreadDiff > 0 ? `+${spreadDiff}` : spreadDiff} Interni Extra</span>
                                    <span className="font-medium text-slate-800">{spreadDiff > 0 ? '+' : ''}€{(spreadCostAdjustment * PRICE_MULTIPLIER).toFixed(2)}</span>
                                </div>
                            )}

                            {cover && cover.cost > 0 && (
                                <div className="flex justify-between text-sm">
                                    <span className="text-slate-600">Upgrade Cover <span className="text-xs text-slate-400 block">{cover.name}</span></span>
                                    <span className="font-medium">€{(cover.cost * PRICE_MULTIPLIER).toFixed(2)}</span>
                                </div>
                            )}

                            {spine && spine.cost > 0 && (
                                <div className="flex justify-between text-sm">
                                    <span className="text-slate-600">Upgrade Costa <span className="text-xs text-slate-400 block">{spine.name}</span></span>
                                    <span className="font-medium">€{(spine.cost * PRICE_MULTIPLIER).toFixed(2)}</span>
                                </div>
                            )}

                             {box && box.cost > 0 && (
                                <div className="flex justify-between text-sm">
                                    <span className="text-slate-600">Box <span className="text-xs text-slate-400 block">{box.name}</span></span>
                                    <span className="font-medium">€{(box.cost * PRICE_MULTIPLIER).toFixed(2)}</span>
                                </div>
                            )}

                            {(extraMinis > 0 || miniCoverCostTotal > 0 || miniSpineCostTotal > 0) && (
                                <div className="border-t border-slate-100 pt-2 mt-2">
                                    {extraMinis > 0 && (
                                        <div className="flex justify-between text-sm">
                                            <span className="text-slate-600">Mini Extra ({extraMinis})</span>
                                            <span className="font-medium">€{(miniBaseCostTotal * PRICE_MULTIPLIER).toFixed(2)}</span>
                                        </div>
                                    )}
                                    {miniCoverCostTotal > 0 && (
                                        <div className="flex justify-between text-sm">
                                            <span className="text-slate-600">Upg. Cover Mini (x{miniCount})</span>
                                            <span className="font-medium">€{(miniCoverCostTotal * PRICE_MULTIPLIER).toFixed(2)}</span>
                                        </div>
                                    )}
                                    {miniSpineCostTotal > 0 && (
                                        <div className="flex justify-between text-sm">
                                            <span className="text-slate-600">Upg. Costa Mini (x{miniCount})</span>
                                            <span className="font-medium">€{(miniSpineCostTotal * PRICE_MULTIPLIER).toFixed(2)}</span>
                                        </div>
                                    )}
                                </div>
                            )}

                            {paidExtras.map(({item, paidQty}) => (
                                <div key={item.id} className="flex justify-between text-sm">
                                    <span className="text-slate-600">{paidQty > 1 ? `${paidQty}x ` : ''}{item.name}</span>
                                    <span className="font-medium">€{(item.cost * paidQty * PRICE_MULTIPLIER).toFixed(2)}</span>
                                </div>
                            ))}

                            {totalVariationsPriceClient === 0 && (
                                <div className="text-sm text-slate-400 italic text-center py-2">Nessuna variazione di prezzo.</div>
                            )}
                        </div>

                        {/* Totals */}
                        <div className="border-t-2 border-slate-200 mt-4 pt-3">
                            <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-4">
                                <div className="flex justify-between items-end">
                                    <div>
                                        <div className="text-xs text-indigo-400 font-bold uppercase tracking-wider mb-1">Totale Finale</div>
                                        <div className="text-xs text-indigo-300">(Contratto + Variazioni)</div>
                                    </div>
                                    <div className="text-3xl font-bold text-indigo-700 leading-none">€{finalPriceClient.toFixed(2)}</div>
                                </div>
                            </div>

                            <div className="flex items-center justify-between p-2 mt-4 bg-slate-100 rounded-lg no-print">
                                <div className="flex items-center gap-2">
                                    <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider">IVA (%)</label>
                                    <input 
                                        type="number" min="0" max="100" value={vatRate}
                                        onChange={(e) => setVatRate(Number(e.target.value))}
                                        className="w-14 py-1 px-1 text-center bg-white border border-slate-300 rounded text-sm font-medium outline-none"
                                    />
                                </div>
                                <div className="text-right">
                                    <div className="text-[10px] text-slate-400 uppercase tracking-wide">Totale Ivato</div>
                                    <div className="text-xl font-bold text-slate-800 leading-none">€{priceWithVat.toFixed(2)}</div>
                                </div>
                            </div>
                            
                            <div className="hidden print-only mt-2 text-right">
                                <div className="text-sm text-slate-500">Totale Ivato ({vatRate}%): <span className="font-bold text-slate-900">€{priceWithVat.toFixed(2)}</span></div>
                            </div>
                        </div>

                        {/* STUDIO DATA SECTION (Always Visible) */}
                        <div className="mt-6 pt-4 border-t-2 border-dashed border-slate-300 no-print animate-fade-in">
                            <h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                                <span className="w-2 h-2 rounded-full bg-red-500"></span>
                                Dati Studio & Margine (Privato)
                            </h3>
                            <div className="bg-slate-800 rounded-lg p-4 text-slate-300 text-sm space-y-2">
                                <div className="flex justify-between">
                                    <span>Costo Base Album:</span>
                                    <span>€{baseStudioCost.toFixed(2)}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span>Costo Variazioni:</span>
                                    <span>€{totalVariationsCostStudio.toFixed(2)}</span>
                                </div>
                                <div className="border-t border-slate-600 my-2"></div>
                                <div className="flex justify-between text-white font-semibold">
                                    <span>Totale Costo Studio:</span>
                                    <span>€{totalStudioCost.toFixed(2)}</span>
                                </div>
                                <div className="flex justify-between text-green-400 font-bold text-base pt-1">
                                    <span>Margine (Utile):</span>
                                    <span>€{studioMargin.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        /********************************************************************************
         *  3. MAIN APP
         ********************************************************************************/
        
        const App = () => {
            const INITIAL_STATE = {
                contract: null,
                spreadCount: STANDARD_SPREADS,
                selectedCoverId: null,
                selectedSpineId: SPINE_OPTIONS[0].id, 
                selectedBoxId: null,
                miniCount: INCLUDED_MINIS,
                selectedMiniCoverId: MINI_COVER_OPTIONS[0].id,
                selectedMiniSpineId: MINI_SPINE_OPTIONS[0].id,
                extras: {},
                includedExtraCounts: {} // Mappa ID Extra -> Quantità Inclusa
            };

            const [state, setState] = useState(INITIAL_STATE);
            
            // Stato temporaneo Setup Contratto
            const [tempContract, setTempContract] = useState({
                clientName: '',
                agreedPrice: 370, // Default base price logic
                albumId: ALBUMS[0].id,
                includedSpreads: STANDARD_SPREADS,
                includedMinis: INCLUDED_MINIS,
                // contractExtrasCost rimosso
            });

            // Logic to Auto-Calculate Contract Price based on inputs
            useEffect(() => {
                const selectedAlbum = ALBUMS.find(a => a.id === tempContract.albumId);
                const albumBaseCost = selectedAlbum ? selectedAlbum.cost : 0;
                
                // Logic: 370 standard includes 2 minis. 
                // If user changes minis, price adjusts by EXTRA_MINI_BASE_COST (50)
                const miniDifference = tempContract.includedMinis - INCLUDED_MINIS; // e.g. 0 - 2 = -2
                const miniAdjustment = miniDifference * EXTRA_MINI_BASE_COST; // -2 * 50 = -100
                
                // PREZZO CONTRATTO = (Costo Base + Variazioni Base) * MOLTIPLICATORE
                const calculatedPrice = (albumBaseCost + miniAdjustment) * PRICE_MULTIPLIER;

                // Update only the price
                setTempContract(prev => ({ ...prev, agreedPrice: calculatedPrice }));
            }, [tempContract.albumId, tempContract.includedMinis]);


            // Derived Data
            const activeAlbumId = state.contract ? state.contract.albumId : tempContract.albumId;
            const selectedAlbum = useMemo(() => ALBUMS.find(a => a.id === activeAlbumId) || null, [activeAlbumId]);
            const compatibleCovers = useMemo(() => getCompatibleCovers(activeAlbumId), [activeAlbumId]);
            const selectedCover = useMemo(() => compatibleCovers.find(c => c.id === state.selectedCoverId) || null, [compatibleCovers, state.selectedCoverId]);
            const selectedSpine = useMemo(() => SPINE_OPTIONS.find(s => s.id === state.selectedSpineId) || null, [state.selectedSpineId]);
            
            const compatibleBoxes = useMemo(() => {
                if (!selectedAlbum) return [];
                return BOX_OPTIONS.filter(b => selectedAlbum.compatibleBoxIds.includes(b.id));
            }, [selectedAlbum]);
            const selectedBox = useMemo(() => compatibleBoxes.find(b => b.id === state.selectedBoxId) || null, [compatibleBoxes, state.selectedBoxId]);
            
            const selectedMiniCover = useMemo(() => MINI_COVER_OPTIONS.find(c => c.id === state.selectedMiniCoverId) || null, [state.selectedMiniCoverId]);
            const selectedMiniSpine = useMemo(() => MINI_SPINE_OPTIONS.find(s => s.id === state.selectedMiniSpineId) || null, [state.selectedMiniSpineId]);

            const selectedExtrasList = useMemo(() => {
                return Object.entries(state.extras)
                    .filter(([_, qty]) => qty > 0)
                    .map(([id, qty]) => {
                        const item = EXTRAS.find(e => e.id === id);
                        return item ? { item, quantity: qty } : null;
                    })
                    .filter(Boolean);
            }, [state.extras]);
            
            // Helper for temp contract display
            const selectedTempAlbum = useMemo(() => ALBUMS.find(a => a.id === tempContract.albumId), [tempContract.albumId]);

            // Handlers
            const handleStartConfiguration = () => {
                if (tempContract.agreedPrice <= 0) {
                    alert("Inserisci un prezzo valido.");
                    return;
                }
                setState(prev => ({
                    ...prev,
                    contract: { ...tempContract },
                    spreadCount: tempContract.includedSpreads,
                    miniCount: tempContract.includedMinis,
                    selectedAlbumId: tempContract.albumId
                }));
            };

            const handleReset = () => {
                if (window.confirm("Sei sicuro? I dati attuali andranno persi.")) {
                    setState(INITIAL_STATE);
                    setTempContract({
                        clientName: '',
                        agreedPrice: 370,
                        albumId: ALBUMS[0].id,
                        includedSpreads: STANDARD_SPREADS,
                        includedMinis: INCLUDED_MINIS
                    });
                }
            };

            const setExtraIncludedQuantity = (extraId, quantity) => {
                setState(prev => ({
                    ...prev,
                    includedExtraCounts: {
                        ...prev.includedExtraCounts,
                        [extraId]: quantity
                    }
                }));
            };

            // RENDER SETUP SCREEN
            if (!state.contract) {
                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-4">
                        <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 animate-fade-in">
                            <div className="flex items-center gap-3 mb-6 text-indigo-900">
                                <div className="p-2 bg-indigo-100 rounded-lg">
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                </div>
                                <h1 className="text-2xl font-bold">Dati Contratto</h1>
                            </div>
                            
                            <div className="space-y-5">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Nome Sposi / Cliente</label>
                                    <input type="text" className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Es. Mario & Rossi" value={tempContract.clientName} onChange={e => setTempContract({...tempContract, clientName: e.target.value})} />
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Modello</label>
                                        <select className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white" value={tempContract.albumId} onChange={e => setTempContract({...tempContract, albumId: e.target.value})}>
                                            {ALBUMS.map(a => (<option key={a.id} value={a.id}>{a.name}</option>))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Formato</label>
                                        <input type="text" disabled className="w-full px-4 py-2 border border-slate-200 bg-slate-50 text-slate-500 rounded-lg outline-none" value={selectedTempAlbum?.dimensions || ''} />
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Interni Inclusi</label>
                                        <input type="number" className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" value={tempContract.includedSpreads} onChange={e => setTempContract({...tempContract, includedSpreads: Number(e.target.value)})} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Mini Inclusi</label>
                                        <input type="number" className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" value={tempContract.includedMinis} onChange={e => setTempContract({...tempContract, includedMinis: Number(e.target.value)})} />
                                    </div>
                                </div>

                                {/* Removed Extra da Contratto Input Field */}

                                <div className="pt-2 bg-slate-50 p-4 rounded-xl border border-slate-200">
                                    <label className="block text-sm font-bold text-slate-800 mb-1">Prezzo Concordato (Calcolato)</label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-2 text-slate-400">€</span>
                                        <input type="number" className="w-full pl-8 pr-4 py-2 border-2 border-indigo-100 rounded-lg focus:border-indigo-500 focus:ring-0 outline-none font-bold text-lg text-slate-900 bg-white" placeholder="0.00" value={tempContract.agreedPrice || ''} onChange={e => setTempContract({...tempContract, agreedPrice: Number(e.target.value)})} />
                                    </div>
                                    <p className="text-xs text-slate-500 mt-1">Include {tempContract.includedMinis} Mini</p>
                                </div>

                                <button onClick={handleStartConfiguration} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-indigo-200 mt-4 flex justify-center items-center gap-2">
                                    Inizia Configurazione <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // RENDER MAIN APP
            return (
                <div className="min-h-screen flex flex-col">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm no-print">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="bg-indigo-600 text-white p-1.5 rounded-lg">
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold text-slate-900 tracking-tight leading-none">Configuratore Album</h1>
                                    <span className="text-xs text-slate-500 font-medium">{state.contract.clientName}</span>
                                </div>
                            </div>
                            <div className="text-sm text-slate-500 hidden sm:block">Studio Fotografico Andrea Materia</div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow w-full">
                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            <div className="lg:col-span-8 space-y-10 no-print">
                                {/* 1. Album Info (Read Only) */}
                                <section className="animate-fade-in">
                                    <div className="flex items-center gap-3 mb-4">
                                        <span className="flex items-center justify-center w-8 h-8 rounded-full bg-slate-900 text-white text-sm font-bold">1</span>
                                        <h2 className="text-xl font-bold text-slate-800">Interni</h2>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                        <div className="mb-4 pb-4 border-b border-slate-100">
                                            <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-1">Album Base (da Contratto)</h3>
                                            <div className="text-lg font-semibold text-slate-800">{selectedAlbum?.name}</div>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <div>
                                                <label className="font-semibold text-slate-700 block">Numero Interni Totale</label>
                                                <p className="text-xs text-slate-400 mt-1">Inclusi nel contratto: {state.contract.includedSpreads}</p>
                                            </div>
                                            <div className="flex items-center gap-4 bg-slate-50 p-2 rounded-lg border border-slate-200">
                                                <button onClick={() => setState(p => ({...p, spreadCount: Math.max(10, p.spreadCount - 1)}))} className="w-10 h-10 rounded-full bg-white border border-slate-300 font-bold hover:text-indigo-600">-</button>
                                                <span className="text-xl font-bold text-indigo-900 w-12 text-center">{state.spreadCount}</span>
                                                <button onClick={() => setState(p => ({...p, spreadCount: p.spreadCount + 1}))} className="w-10 h-10 rounded-full bg-indigo-600 text-white font-bold hover:bg-indigo-700">+</button>
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                {/* 2. Cover & Spine */}
                                <section>
                                    <div className="flex items-center gap-3 mb-4">
                                        <span className="flex items-center justify-center w-8 h-8 rounded-full bg-slate-900 text-white text-sm font-bold">2</span>
                                        <h2 className="text-xl font-bold text-slate-800">Copertina e Costa</h2>
                                    </div>
                                    <div className="space-y-6">
                                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                            <h3 className="font-bold text-slate-700 mb-3">Materiale Costa (Dorso)</h3>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2">
                                                {SPINE_OPTIONS.map(spine => (
                                                    <SelectionCard key={spine.id} item={spine} isSelected={state.selectedSpineId === spine.id} onSelect={() => setState(p => ({...p, selectedSpineId: spine.id}))} />
                                                ))}
                                            </div>
                                        </div>
                                        <div>
                                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Copertine Base</h3>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                                {compatibleCovers.filter(c => c.category === 'Base').map(c => (
                                                    <SelectionCard key={c.id} item={c} isSelected={state.selectedCoverId === c.id} onSelect={() => setState(p => ({...p, selectedCoverId: c.id}))} />
                                                ))}
                                            </div>
                                        </div>
                                        <div>
                                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Copertine Premium</h3>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                                {compatibleCovers.filter(c => c.category === 'Upgrade').map(c => (
                                                    <SelectionCard key={c.id} item={c} isSelected={state.selectedCoverId === c.id} onSelect={() => setState(p => ({...p, selectedCoverId: c.id}))} />
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                {/* 3. Box */}
                                <section>
                                    <div className="flex items-center gap-3 mb-4">
                                        <span className="flex items-center justify-center w-8 h-8 rounded-full bg-slate-900 text-white text-sm font-bold">3</span>
                                        <h2 className="text-xl font-bold text-slate-800">Box</h2>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        {compatibleBoxes.map(b => (
                                            <SelectionCard key={b.id} item={b} isSelected={state.selectedBoxId === b.id} onSelect={() => setState(p => ({...p, selectedBoxId: b.id}))} />
                                        ))}
                                    </div>
                                </section>

                                {/* 4. Mini */}
                                <section>
                                    <div className="flex items-center gap-3 mb-4">
                                        <span className="flex items-center justify-center w-8 h-8 rounded-full bg-slate-900 text-white text-sm font-bold">4</span>
                                        <h2 className="text-xl font-bold text-slate-800">Mini Album</h2>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mb-6">
                                        <div className="flex justify-between items-center">
                                            <div>
                                                <label className="font-semibold text-slate-700 block">Quantità Totale</label>
                                                <p className="text-xs text-slate-400 mt-1">Inclusi nel contratto: {state.contract.includedMinis}</p>
                                            </div>
                                            <div className="flex items-center gap-4 bg-slate-50 p-2 rounded-lg border border-slate-200">
                                                <button onClick={() => setState(p => ({...p, miniCount: Math.max(0, p.miniCount - 1)}))} className="w-10 h-10 rounded-full bg-white border border-slate-300 font-bold hover:text-indigo-600">-</button>
                                                <span className="text-xl font-bold text-indigo-900 w-12 text-center">{state.miniCount}</span>
                                                <button onClick={() => setState(p => ({...p, miniCount: p.miniCount + 1}))} className="w-10 h-10 rounded-full bg-indigo-600 text-white font-bold hover:bg-indigo-700">+</button>
                                            </div>
                                        </div>
                                    </div>
                                    {state.miniCount > 0 && (
                                        <div className="space-y-6">
                                            <div>
                                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Costa Mini (Prezzo Cad.)</h3>
                                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                                                    {MINI_SPINE_OPTIONS.map(s => (
                                                        <SelectionCard key={s.id} item={s} isSelected={state.selectedMiniSpineId === s.id} onSelect={() => setState(p => ({...p, selectedMiniSpineId: s.id}))} />
                                                    ))}
                                                </div>
                                            </div>
                                            <div>
                                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Copertina Mini (Prezzo Cad.)</h3>
                                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                                                    {MINI_COVER_OPTIONS.map(o => (
                                                        <SelectionCard key={o.id} item={o} isSelected={state.selectedMiniCoverId === o.id} onSelect={() => setState(p => ({...p, selectedMiniCoverId: o.id}))} />
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </section>

                                {/* 5. Extras */}
                                <section>
                                    <div className="flex items-center gap-3 mb-4">
                                        <span className="flex items-center justify-center w-8 h-8 rounded-full bg-slate-900 text-white text-sm font-bold">5</span>
                                        <h2 className="text-xl font-bold text-slate-800">Extra</h2>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                        {EXTRAS.map(extra => (
                                            <SelectionCard 
                                                key={extra.id} item={extra} 
                                                isSelected={!!state.extras[extra.id]} 
                                                onSelect={() => !extra.allowQuantity && setState(p => ({...p, extras: {...p.extras, [extra.id]: p.extras[extra.id] ? 0 : 1}}))}
                                                quantity={extra.allowQuantity ? (state.extras[extra.id] || 0) : undefined}
                                                onQuantityChange={(q) => setState(p => ({...p, extras: {...p.extras, [extra.id]: q}}))}
                                                // Nuove props per "Incluso nel contratto"
                                                includedQuantity={state.includedExtraCounts[extra.id] || 0}
                                                onIncludedQuantityChange={(qty) => setExtraIncludedQuantity(extra.id, qty)}
                                            />
                                        ))}
                                    </div>
                                </section>
                            </div>

                            <div className="lg:col-span-4">
                                <Summary 
                                    contract={state.contract} album={selectedAlbum} spreadCount={state.spreadCount}
                                    cover={selectedCover} spine={selectedSpine} box={selectedBox}
                                    extras={selectedExtrasList} includedExtraCounts={state.includedExtraCounts}
                                    miniCount={state.miniCount}
                                    miniCover={selectedMiniCover} miniSpine={selectedMiniSpine} onReset={handleReset}
                                />
                            </div>
                        </div>
                    </main>
                    <footer className="bg-white border-t border-slate-200 mt-auto py-6 text-center no-print">
                        <p className="text-slate-400 font-medium text-sm">Developed with ❤️ by Angelo</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>